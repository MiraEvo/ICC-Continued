# 代码质量问题修复计划

基于对项目的全面分析，我发现了以下需要修复的代码质量问题：

## 高优先级问题

### 1. 空 catch 块问题
**位置**: [ScreenshotWindow.xaml.cs:L317-318](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/Popups/ScreenshotWindow.xaml.cs#L317-L318)
```csharp
catch (TaskCanceledException) {}
catch (Exception ex) {}
```
**修复方案**: 添加适当的日志记录或错误处理

### 2. async void 方法问题
**位置**: 多个文件
- [ScreenshotWindow.xaml.cs:L242](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/Popups/ScreenshotWindow.xaml.cs#L242) - `CaptureFullScreen`
- [ScreenshotWindow.xaml.cs:L408](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/Popups/ScreenshotWindow.xaml.cs#L408) - `OnSelectionCompleted`
- [MainWindow.xaml.cs:L1576](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.xaml.cs#L1576) - `ApplySpecialVersionSettings`
- [MainWindow.xaml.cs:L1996](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.xaml.cs#L1996) - `AutoUpdate`
- [MainWindow.AutoFold.cs:L41](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.Partials/Utilities/MainWindow.AutoFold.cs#L41) - `FoldFloatingBar_MouseUp`
- [MainWindow.FloatingBarIcons.cs:L298](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.Partials/UI/MainWindow.FloatingBarIcons.cs#L298) - `HideSubPanels`

**修复方案**: 
- 事件处理器保持 async void，但添加异常处理
- 其他方法改为 async Task

### 3. 过于宽泛的异常捕获
**位置**: 多个文件使用 `catch (Exception ex)` 模式

**修复方案**: 使用更具体的异常类型

## 中优先级问题

### 4. 资源管理问题
**位置**: [CountdownTimerWindow.xaml.cs:L57](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/Windows/CountdownTimerWindow.xaml.cs#L57)
```csharp
TextBlockHour.Foreground = new SolidColorBrush(StringToColor("#FF5B5D5F"));
```
频繁创建 SolidColorBrush 对象

**修复方案**: 缓存画笔对象或使用 Freeze()

### 5. 事件订阅内存泄漏风险
**位置**: [MainWindow.PPT.cs](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.Partials/Services/MainWindow.PPT.cs)
PPT 事件订阅后未取消订阅

**修复方案**: 在 Dispose 或窗口关闭时取消订阅

## 低优先级问题

### 6. 调试代码清理
**位置**: [MainWindow.Eraser.cs:L114](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/MainWindow.Partials/Features/MainWindow.Eraser.cs#L114)
```csharp
// 我有受虐倾向，被这个bug硬控10秒钟，请大家嘲笑我
```

**位置**: [StorageSettingsViewModel.cs](file:///c:/Users/SakuraStar/Desktop/ICC-Continued/InkCanvasForClass/ViewModels/Settings/StorageSettingsViewModel.cs) 多处使用 `Debug.WriteLine`

**修复方案**: 移除或替换为正式日志

---

## 修复步骤

1. **修复空 catch 块** - 添加日志记录
2. **修复 async void** - 添加异常处理，部分改为 async Task
3. **改进异常处理** - 使用具体异常类型
4. **优化资源管理** - 缓存画笔对象
5. **修复事件订阅** - 添加取消订阅逻辑
6. **清理调试代码** - 移除或替换

请确认这个计划，我将开始执行修复。