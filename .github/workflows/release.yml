name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false
      create_tag:
        description: 'Create Git tag?'
        required: false
        type: boolean
        default: true
      generate_notes:
        description: 'Generate release notes automatically?'
        required: false
        type: boolean
        default: true

env:
  SOLUTION_PATH: 'Ink Canvas.sln'

jobs:
  build-and-package:
    name: Build & Package (${{ matrix.platform }})
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x86, x64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          submodules: recursive

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore "${{ env.SOLUTION_PATH }}"

      - name: Build and Publish
        run: |
          dotnet publish "InkCanvasForClass/InkCanvasForClass.csproj" `
            --configuration Release `
            --framework net8.0-windows `
            --runtime win-${{ matrix.platform }} `
            --self-contained false `
            --output ./publish/${{ matrix.platform }} `
            -p:PublishReadyToRun=true `
            --no-restore

      - name: Run tests
        run: |
          dotnet test "${{ env.SOLUTION_PATH }}" `
            --configuration Release `
            -p:Platform=${{ matrix.platform }} `
            --no-build `
            --no-restore `
            --logger "console;verbosity=minimal" `
            --results-directory TestResults `
            --collect:"XPlat Code Coverage"

      - name: Create portable package
        run: Compress-Archive -Path "./publish/${{ matrix.platform }}/*" -DestinationPath "./InkCanvas-${{ matrix.platform }}-${{ github.event.inputs.version }}.zip" -Force

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact-${{ matrix.platform }}
          path: ./InkCanvas-${{ matrix.platform }}-${{ github.event.inputs.version }}.zip
          retention-days: 30
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.platform }}
          path: TestResults/
          retention-days: 7


  create-release:
    name: Create GitHub Release
    needs: build-and-package
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create version info file
        run: |
          echo "{\"Version\": \"${{ github.event.inputs.version }}\", \"BuildDate\": \"$(date -u +"%Y-%m-%d %H:%M:%S UTC")\", \"Commit\": \"${{ github.sha }}\", \"Branch\": \"${{ github.ref_name }}\", \".NET\": \"8.0\"}" > ./version-info.json

      - name: Checkout code for tagging
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Git Tag
        if: github.event.inputs.create_tag == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "${{ github.event.inputs.version }}" -m "Release ${{ github.event.inputs.version }}"
          git push origin "${{ github.event.inputs.version }}"

      - name: Generate Release Notes
        if: github.event.inputs.generate_notes == 'true'
        id: release_notes
        run: |
          # (Script remains the same)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "## Changes since $LAST_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "## Initial Release" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "First release of Ink Canvas for Class." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: |
            ${{ steps.release_notes.outputs.release_notes }}
            
            ## Installation
            - Download the appropriate zip file for your system architecture
            - Extract the zip file to your desired location
            - Run `InkCanvasForClass.exe`
            
            ## System Requirements
            - Windows 10/11 (x64 or x86)
            - .NET 8.0 Runtime
            
            ## What's Included
            - `InkCanvas-x64-${{ github.event.inputs.version }}.zip` - 64-bit version
            - `InkCanvas-x86-${{ github.event.inputs.version }}.zip` - 32-bit version
            - `version-info.json` - Build information
            
            ---
            **Note**: This release was created automatically from commit ${{ github.sha }}
          files: |
            artifacts/release-artifact-*/*.zip
            ./version-info.json
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-release:
    name: Notify Release Complete
    needs: [build-and-package, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Status
        run: |
          if [ "${{ needs.build-and-package.result }}" == "success" ] && [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "‚úÖ Release ${{ github.event.inputs.version }} completed successfully!"
            echo "üì¶ Available at: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}"
          else
            echo "‚ùå Release failed!"
            echo "Build status: ${{ needs.build-and-package.result }}"
            echo "Release status: ${{ needs.create-release.result }}"
            exit 1
          fi
